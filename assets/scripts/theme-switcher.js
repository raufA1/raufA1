/**
 * Theme Switcher - Qaranlƒ±q v…ô ƒ∞≈üƒ±qlƒ± Rejim D…ôyi≈üdirici
 * GitHub Profile √º√ß√ºn dinamik rejim d…ôyi≈üdirici
 */

class ThemeSwitcher {
  constructor() {
    this.currentTheme = this.getStoredTheme() || this.getSystemTheme();
    this.themeKey = 'github-profile-theme';
    this.themes = {
      light: {
        name: 'light',
        displayName: 'ƒ∞≈üƒ±qlƒ± Rejim',
        icon: '‚òÄÔ∏è',
        cssFile: 'assets/styles/profile-light.css'
      },
      dark: {
        name: 'dark',
        displayName: 'Qaranlƒ±q Rejim', 
        icon: 'üåô',
        cssFile: 'assets/styles/profile-dark.css'
      },
      auto: {
        name: 'auto',
        displayName: 'Avtomatik',
        icon: 'üåì',
        cssFile: null // System preference-…ô …ôsas…ôn
      }
    };
    
    this.init();
  }

  /**
   * Theme Switcher-i i≈ü…ô salƒ±r
   */
  init() {
    this.createThemeButton();
    this.applyTheme(this.currentTheme);
    this.setupEventListeners();
    this.setupSystemThemeWatcher();
    this.updateBadgeImages();
  }

  /**
   * Sistemd…ôn m√∂vcud rejimi alƒ±r
   */
  getSystemTheme() {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return 'light';
  }

  /**
   * Saxlanmƒ±≈ü rejimi localStorage-d…ôn alƒ±r
   */
  getStoredTheme() {
    try {
      return localStorage.getItem(this.themeKey);
    } catch (error) {
      console.warn('LocalStorage m√∂vcud deyil:', error);
      return null;
    }
  }

  /**
   * Rejimi localStorage-d…ô saxlayƒ±r
   */
  storeTheme(theme) {
    try {
      localStorage.setItem(this.themeKey, theme);
    } catch (error) {
      console.warn('Theme saxlanƒ±la bilm…ôdi:', error);
    }
  }

  /**
   * Theme button yaradƒ±r
   */
  createThemeButton() {
    // ∆èg…ôr button artƒ±q m√∂vcuddursa, geri qayƒ±t
    if (document.getElementById('theme-switcher')) return;

    const button = document.createElement('button');
    button.id = 'theme-switcher';
    button.className = 'theme-switcher-btn';
    button.setAttribute('aria-label', 'Rejimi d…ôyi≈üdir');
    button.setAttribute('title', 'Rejimi d…ôyi≈üdir');
    
    // Button still…ôri
    button.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: var(--bg-tertiary, #f1f3f4);
      border: 2px solid var(--border-primary, #d0d7de);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px var(--shadow-medium, rgba(0,0,0,0.1));
      backdrop-filter: blur(10px);
    `;

    // Hover effekti
    button.addEventListener('mouseenter', () => {
      button.style.transform = 'scale(1.1)';
      button.style.boxShadow = '0 6px 20px var(--shadow-heavy, rgba(0,0,0,0.2))';
    });

    button.addEventListener('mouseleave', () => {
      button.style.transform = 'scale(1)';
      button.style.boxShadow = '0 4px 12px var(--shadow-medium, rgba(0,0,0,0.1))';
    });

    // Click event
    button.addEventListener('click', () => this.toggleTheme());

    // Dropdown menu yaradƒ±r
    this.createThemeDropdown(button);

    // Body-…ô …ôlav…ô et
    document.body.appendChild(button);

    this.updateButtonContent();
  }

  /**
   * Theme dropdown menu yaradƒ±r
   */
  createThemeDropdown(button) {
    const dropdown = document.createElement('div');
    dropdown.id = 'theme-dropdown';
    dropdown.className = 'theme-dropdown';
    dropdown.style.cssText = `
      position: absolute;
      top: 60px;
      right: 0;
      background: var(--bg-secondary, #f6f8fa);
      border: 1px solid var(--border-primary, #d0d7de);
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 8px 24px var(--shadow-heavy, rgba(0,0,0,0.15));
      display: none;
      min-width: 150px;
      backdrop-filter: blur(10px);
    `;

    Object.values(this.themes).forEach(theme => {
      const option = document.createElement('button');
      option.className = 'theme-option';
      option.textContent = `${theme.icon} ${theme.displayName}`;
      option.style.cssText = `
        display: block;
        width: 100%;
        padding: 8px 12px;
        background: none;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
        color: var(--text-primary, #24292f);
        font-size: 14px;
        transition: background-color 0.2s ease;
      `;

      option.addEventListener('mouseenter', () => {
        option.style.backgroundColor = 'var(--bg-tertiary, #f1f3f4)';
      });

      option.addEventListener('mouseleave', () => {
        option.style.backgroundColor = 'transparent';
      });

      option.addEventListener('click', (e) => {
        e.stopPropagation();
        this.setTheme(theme.name);
        this.hideDropdown();
      });

      dropdown.appendChild(option);
    });

    button.style.position = 'relative';
    button.appendChild(dropdown);

    // Dropdown g√∂st…ôr/gizl…ô
    button.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      this.toggleDropdown();
    });

    // Bayƒ±rda click olunanda dropdown-u gizl…ôt
    document.addEventListener('click', (e) => {
      if (!button.contains(e.target)) {
        this.hideDropdown();
      }
    });
  }

  /**
   * Dropdown-u g√∂st…ôrir/gizl…ôdir
   */
  toggleDropdown() {
    const dropdown = document.getElementById('theme-dropdown');
    if (dropdown) {
      const isVisible = dropdown.style.display === 'block';
      dropdown.style.display = isVisible ? 'none' : 'block';
    }
  }

  /**
   * Dropdown-u gizl…ôdir
   */
  hideDropdown() {
    const dropdown = document.getElementById('theme-dropdown');
    if (dropdown) {
      dropdown.style.display = 'none';
    }
  }

  /**
   * Button m…ôzmununu yenil…ôyir
   */
  updateButtonContent() {
    const button = document.getElementById('theme-switcher');
    if (button) {
      const theme = this.themes[this.currentTheme];
      button.textContent = theme ? theme.icon : 'üåì';
      button.setAttribute('title', `Hazƒ±rda: ${theme ? theme.displayName : 'Avtomatik'}`);
    }
  }

  /**
   * Rejimi t…ôtbiq edir
   */
  applyTheme(themeName) {
    const resolvedTheme = themeName === 'auto' ? this.getSystemTheme() : themeName;
    
    // CSS faylƒ±nƒ± y√ºkl…ô
    this.loadThemeCSS(resolvedTheme);
    
    // HTML data atributunu yenil…ô
    document.documentElement.setAttribute('data-theme', resolvedTheme);
    document.body.setAttribute('data-theme', resolvedTheme);
    
    // Meta tag-i yenil…ô
    this.updateThemeMetaTag(resolvedTheme);
    
    // Badge ≈ü…ôkill…ôrini yenil…ô
    this.updateBadgeImages();
    
    // GitHub stats ≈ü…ôkill…ôrini yenil…ô
    this.updateGitHubStats(resolvedTheme);
    
    this.currentTheme = themeName;
    this.storeTheme(themeName);
    this.updateButtonContent();
    
    // Event emit et
    this.emitThemeChangeEvent(resolvedTheme);
  }

  /**
   * Theme CSS faylƒ±nƒ± y√ºkl…ôr
   */
  loadThemeCSS(theme) {
    // K√∂hn…ô theme CSS-i sil
    const existingLink = document.querySelector('link[data-theme-css]');
    if (existingLink) {
      existingLink.remove();
    }

    // Yeni theme CSS-i …ôlav…ô et
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = `assets/styles/profile-${theme}.css`;
    link.setAttribute('data-theme-css', theme);
    link.onload = () => {
      console.log(`${theme} theme y√ºkl…ôndi`);
    };
    link.onerror = () => {
      console.error(`${theme} theme y√ºkl…ôn…ô bilm…ôdi`);
    };

    document.head.appendChild(link);
  }

  /**
   * Theme meta tag-ini yenil…ôyir
   */
  updateThemeMetaTag(theme) {
    let metaTag = document.querySelector('meta[name="theme-color"]');
    if (!metaTag) {
      metaTag = document.createElement('meta');
      metaTag.name = 'theme-color';
      document.head.appendChild(metaTag);
    }
    
    const themeColors = {
      light: '#ffffff',
      dark: '#0d1117'
    };
    
    metaTag.content = themeColors[theme] || themeColors.dark;
  }

  /**
   * Badge ≈ü…ôkill…ôrini rejim…ô uyƒüun yenil…ôyir
   */
  updateBadgeImages() {
    const badges = document.querySelectorAll('.badge-item img');
    badges.forEach(badge => {
      const src = badge.src;
      // Badge URL-l…ôrind…ô theme parametrini yenil…ô
      if (src.includes('shields.io')) {
        // shields.io badge-l…ôri √º√ß√ºn labelColor parametrini yenil…ô
        const url = new URL(src);
        if (this.currentTheme === 'dark') {
          url.searchParams.set('labelColor', '1F2937');
        } else {
          url.searchParams.set('labelColor', 'white');
        }
        badge.src = url.toString();
      }
    });
  }

  /**
   * GitHub stats ≈ü…ôkill…ôrini rejim…ô uyƒüun yenil…ôyir
   */
  updateGitHubStats(theme) {
    const statsImages = document.querySelectorAll('img[src*="github-readme-stats"]');
    statsImages.forEach(img => {
      const src = img.src;
      const url = new URL(src);
      
      if (theme === 'dark') {
        url.searchParams.set('theme', 'github_dark');
        url.searchParams.set('bg_color', '0D1117');
        url.searchParams.set('title_color', '3B82F6');
        url.searchParams.set('text_color', 'E5E7EB');
      } else {
        url.searchParams.set('theme', 'default');
        url.searchParams.set('bg_color', 'FFFFFF');
        url.searchParams.set('title_color', '2563EB');
        url.searchParams.set('text_color', '24292F');
      }
      
      img.src = url.toString();
    });
  }

  /**
   * Rejimi d…ôyi≈üir (toggle)
   */
  toggleTheme() {
    const themes = ['light', 'dark', 'auto'];
    const currentIndex = themes.indexOf(this.currentTheme);
    const nextIndex = (currentIndex + 1) % themes.length;
    this.setTheme(themes[nextIndex]);
  }

  /**
   * M√º…ôyy…ôn rejimi t…ôyin edir
   */
  setTheme(themeName) {
    if (this.themes[themeName]) {
      this.applyTheme(themeName);
    }
  }

  /**
   * Sistem rejim d…ôyi≈üikliyini izl…ôyir
   */
  setupSystemThemeWatcher() {
    if (window.matchMedia) {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQuery.addEventListener('change', (e) => {
        if (this.currentTheme === 'auto') {
          this.applyTheme('auto');
        }
      });
    }
  }

  /**
   * Event listener-l…ôri qurur
   */
  setupEventListeners() {
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+Shift+T rejimi d…ôyi≈üir
      if (e.ctrlKey && e.shiftKey && e.key === 'T') {
        e.preventDefault();
        this.toggleTheme();
      }
      
      // Esc dropdown-u baƒülayƒ±r
      if (e.key === 'Escape') {
        this.hideDropdown();
      }
    });

    // Scroll zamanƒ± button opacity-sini d…ôyi≈üir
    window.addEventListener('scroll', () => {
      const button = document.getElementById('theme-switcher');
      if (button) {
        const scrollY = window.scrollY;
        const opacity = Math.max(0.7, 1 - scrollY / 1000);
        button.style.opacity = opacity;
      }
    });
  }

  /**
   * Theme d…ôyi≈üiklik event-i emit edir
   */
  emitThemeChangeEvent(theme) {
    const event = new CustomEvent('themechange', {
      detail: {
        theme: theme,
        timestamp: Date.now()
      }
    });
    window.dispatchEvent(event);
  }

  /**
   * Hazƒ±rki rejimi qaytarƒ±r
   */
  getCurrentTheme() {
    return this.currentTheme;
  }

  /**
   * M√∂vcud rejiml…ôri qaytarƒ±r
   */
  getAvailableThemes() {
    return Object.keys(this.themes);
  }

  /**
   * Theme Switcher-i m…ôhv edir
   */
  destroy() {
    const button = document.getElementById('theme-switcher');
    if (button) {
      button.remove();
    }
    
    // Event listener-l…ôri t…ômizl…ô
    document.removeEventListener('keydown', this.handleKeyDown);
    window.removeEventListener('scroll', this.handleScroll);
  }
}

// CSS animation-larƒ± …ôlav…ô et
const style = document.createElement('style');
style.textContent = `
  .theme-switcher-btn {
    animation: float 3s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% {
      transform: translateY(0px) scale(1);
    }
    50% {
      transform: translateY(-5px) scale(1.05);
    }
  }
  
  .theme-option:active {
    transform: scale(0.95);
  }
  
  @media (max-width: 768px) {
    .theme-switcher-btn {
      width: 45px;
      height: 45px;
      font-size: 18px;
      top: 15px;
      right: 15px;
    }
  }
  
  @media (prefers-reduced-motion: reduce) {
    .theme-switcher-btn {
      animation: none;
    }
  }
`;
document.head.appendChild(style);

// Theme Switcher-i i≈ü…ô sal
let themeSwitcher;

// DOM y√ºkl…ôn…ôn kimi i≈ü…ô sal
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    themeSwitcher = new ThemeSwitcher();
  });
} else {
  themeSwitcher = new ThemeSwitcher();
}

// Export for modules
if (typeof module !== 'undefined' && module.exports) {
  module.exports = ThemeSwitcher;
}

// Global access
window.ThemeSwitcher = ThemeSwitcher;
window.themeSwitcher = themeSwitcher;